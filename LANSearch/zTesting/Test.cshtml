<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test signalr</title>
    <link href="@Url.Content("~/Content/bootstrap.min.css")" rel="stylesheet">
    <link href="@Url.Content("~/Content/bootstrap-theme.min.css")" rel="stylesheet">
    <link href="@Url.Content("~/Content/lansearch.css")" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>LANSearch Log viewer</h1>
        <ul class="nav nav-tabs" role="tablist" id="tabs">
            <li class="active" data-tabid="tabLog"><a href="#">System Log</a></li>
            <li data-tabid="tabRequests"><a href="#">Requests</a></li>
        </ul>
        <div id="tabContainer">
            <div id="tabLog" class="panel panel-default">
                <div class="panel-heading">
                    <div class="btn-group">
                        <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown"><span id="lblLevel">Info</span>&nbsp;<span class="caret"></span></button>
                        <ul class="dropdown-menu" id="ddmLevel">
                            <li><a href="#" data-level="0">Trace</a></li>
                            <li><a href="#" data-level="1">Debug</a></li>
                            <li><a href="#" data-level="2">Info</a></li>
                            <li><a href="#" data-level="3">Warning</a></li>
                            <li><a href="#" data-level="4">Error</a></li>
                            <li><a href="#" data-level="5">Fatal</a></li>
                        </ul>
                    </div>
                </div>
                <div class="panel-body">
                </div>
            </div>
            <div id="tabRequests" class="panel panel-default" style="display:none;">
                <div class="panel-body"></div>
            </div>
            <ul id="discussion"></ul>
        </div>
    </div>

    <script src="@Url.Content("~/Scripts/jquery-1.9.0.min.js")"></script>
    <script src="@Url.Content("~/Scripts/jquery.signalR-2.1.2.js")"></script>
    <script src="@Url.Content("~/Scripts/bootstrap.min.js")"></script>
    <script src="@Url.Content("~/Scripts/lansearch.js")"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/sr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            var tabs = $("#tabContainer").children();
            $("#tabs").on("click", "a", function (e) {
                var target = $(e.target);
                var li = target.parent();
                $(e.delegateTarget).children("li").removeClass("active");
                li.addClass("active");
                target.blur();
                var tab = "#" + li.data("tabid");
                tabs.hide();
                $(tab).show();
                return false;
            });
            var logLevels = ["Trace", "Debug", "Info", "Warn", "Error", "Fatal"];
            var logLevelColors = ["default", "default", "info", "warning", "danger", "danger"];
            var lblLevel = $("#lblLevel");
            var btnLevels = lblLevel.parent();
            var loglevel = 2;
            $("#ddmLevel").on("click", "a", function (e) {
                var target = $(e.target);
                loglevel = target.data("level");
                lblLevel.text(logLevels[loglevel]);
                btnLevels.removeClass("btn-default btn-info btn-warning btn-danger");
                btnLevels.addClass("btn-" + logLevelColors[loglevel]);
                target.parents(".btn-group").removeClass("open");
                return false;
            });

            function htmlEncode(value) {
                //create a in-memory div, set it's inner text(which jQuery automatically encodes)
                //then grab the encoded contents back out.  The div never exists on the page.
                return $('<div />').text(value).html();
            }

            var log = $.connection.testHub;
            var logEventDiv = $("#tabLog .panel-body");
            var eventsLimit = 500;
            var eventCount = 0;
            log.client.logEvent = function (datetime, logLevel, classname, message) {
                var logLevelId = logLevels.indexOf(logLevel);
                if (logLevelId < loglevel)
                    return;

                eventCount++;
                if (eventCount > eventsLimit) {
                    logEventDiv.children().last().remove();
                }

                logEventDiv.prepend('<div class="row small"><div class="col-xs-2">' + htmlEncode(datetime) + '</div>' +
                    '<span class="label label-' + logLevelColors[logLevelId] + ' col-xs-1">' + htmlEncode(logLevel) + '</span>' +
                    '<div class="col-xs-3">' + htmlEncode(classname) + '</div>' +
                    '<div class="col-xs-6">' + htmlEncode(message) + '</div></div>');
            };
            var logRequestDiv = $("#tabRequests .panel-body");
            var requestLimit = 500;
            var requestCount = 0;
            log.client.logReuqest = function (datetime, message) {
                requestCount++;
                if (requestCount > requestLimit) {
                    logRequestDiv.children().last().remove();
                }
                logRequestDiv.prepend('<div class="row small"><div class="col-xs-2">' + htmlEncode(datetime) + '</div><div class="col-xs-10">' + htmlEncode(message) + '</div></div>');
            };
            // Start the connection.
            $.connection.hub.start();
        });
    </script>
</body>
</html>